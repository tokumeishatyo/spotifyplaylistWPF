## PBI-07: 楽曲検索機能 外部仕様書

**文書バージョン:** 1.0
**作成日:** 2025/06/15
**対象読者:** 開発チーム（プロダクトオーナー、スクラムマスター、開発者）

### 1. はじめに

#### 1.1. 本書の目的
本書は、将来のリリース候補である「PBI-07: 楽曲検索機能」の外部仕様を詳細に定義することを目的とします。開発チームは本書をスプリント計画のインプットとして利用してください。

#### 1.2. 担当モジュール
本機能は、主に新しい機能モジュール **`SpotifyManager.Search.dll`** で開発されることを想定しています。UIの変更は **`SpotifyManager.Wpf.exe`** に、ViewModelの拡張は **`SpotifyManager.Playlist.dll`** に影響します。

### 2. 機能概要
本機能は、ユーザーが自身の全プレイリストを横断して、特定の条件に合致する楽曲を効率的に見つけ出すための検索インターフェースを提供します。検索方法として、具体的なキーワードを入力する「キーワード検索」と、気分を選択する「おまかせ検索」の2種類を実装します。検索結果は楽曲リストとして表示され、表示件数の制御も可能です。

### 3. 画面仕様

本機能は、既存のメイン画面 (`MainView.xaml`) の上部に、展開・格納可能な検索パネルを追加することで実現します。

#### 3.1. UIコンポーネントの配置とレイアウト
- **検索パネル:** メイン画面のヘッダーとプレイリスト一覧の間に、アコーディオン形式（`Expander`）の検索パネルを配置します。初期状態では折りたたまれています。
- **パネルヘッダー:** 「楽曲を検索する ▼」といったテキストを表示します。
- **パネル内部:** 以下のコンポーネントを配置します。

| コンポーネント名 | 種類 | ラベル/テキスト | 概要 |
| :--- | :--- | :--- | :--- |
| `SearchModeSelector` | ラジオボタン | `キーワード検索`, `おまかせ検索` | 検索モードを切り替える。デフォルトは「キーワード検索」。 |
| `KeywordSearchPanel` | パネル | - | 「キーワード検索」選択時に表示される。 |
| `TrackNameTextBox` | テキストボックス | 曲名 | 検索する曲名を入力する。 |
| `ArtistNameTextBox` | テキストボックス | アーティスト名 | 検索するアーティスト名を入力する。 |
| `AlbumNameTextBox` | テキストボックス | アルバム名 | 検索するアルバム名を入力する。 |
| `OmakaseSearchPanel` | パネル | - | 「おまかせ検索」選択時に表示される。 |
| `MoodComboBox` | コンボボックス | 今日の気分 | 気分を選択する。項目は後述。 |
| `ResultCountComboBox` | コンボボックス | 表示件数 | `20`, `50` から選択。デフォルトは`20`。 |
| `SearchButton` | ボタン | `検索` | 入力された条件で検索を実行する。 |
| `ClearButton` | ボタン | `クリア` | 全ての検索条件と検索結果をリセットする。 |
| `SearchResultPanel` | パネル | 検索結果 | 検索結果の楽曲リストを表示するエリア。 |
| `SearchResultListView` | リストビュー | - | 検索結果の楽曲を表示する。 |

#### 3.2. 画面の振る舞い
1.  ユーザーが検索パネルのヘッダーをクリックすると、パネルが展開され、検索条件入力エリアが表示されます。
2.  `SearchModeSelector`でモードを切り替えると、`KeywordSearchPanel`と`OmakaseSearchPanel`の表示が連動して切り替わります。
3.  `SearchButton`をクリックすると、検索が実行され、`SearchResultPanel`に結果が表示されます。プレイリスト一覧は一時的に非表示になるか、高さを縮小して検索結果エリアを優先的に表示します。
4.  `ClearButton`をクリックすると、全ての入力フィールドと検索結果がクリアされ、プレイリスト一覧が元の表示に戻ります。

### 4. 機能仕様と受け入れ基準

#### 4.1. PBI-07.1: キーワード検索機能
- **仕様:**
    - 「曲名」「アーティスト名」「アルバム名」の各テキストボックスに入力されたキーワードで、ユーザーの全プレイリスト内の楽曲を検索する。
    - 複数のボックスに入力された場合は、**AND条件**で絞り込み検索を行う（例: 曲名に"A"を含み、かつアーティスト名に"B"を含む楽曲）。
    - 各キーワードは、大文字・小文字を区別しない**部分一致**で検索する。
    - いずれかのボックスに値が入力されている場合のみ、「検索」ボタンは活性化する。
- **受け入れ基準:**
    - GIVEN: 「キーワード検索」モードで、「曲名」に"Love"と入力し
    - WHEN: 「検索」ボタンをクリックすると
    - THEN: 曲名に"Love"（大文字小文字問わず）を含む楽曲のみが検索結果に表示されること。
    - GIVEN: 「アーティスト名」に"Queen"、「アルバム名」に"Opera"と入力し
    - WHEN: 「検索」ボタンをクリックすると
    - THEN: アーティスト名に"Queen"を含み、かつアルバム名に"Opera"を含む楽曲のみが検索結果に表示されること。

#### 4.2. PBI-07.2: おまかせ検索機能
- **仕様:**
    - 「おまかせ検索」モードを選択すると、「今日の気分」コンボボックスが利用可能になる。
    - コンボボックスには、以下の気分が選択肢として表示される。
        - `アップテンポ`
        - `リラックス`
        - `集中したい時`
        - `パーティー`
        - `切ない気分`
    - 各気分には、検索に使用するキーワード群が内部的にマッピングされている。選択された気分に対応するキーワード群を使い、ユーザーの全楽曲の「曲名」「アルバム名」を**OR条件**で検索する。
- **内部マッピング（例）:**
    - **アップテンポ:** `upbeat`, `dance`, `pop`, `party`, `happy`
    - **リラックス:** `chill`, `acoustic`, `lo-fi`, `relax`, `ambient`, `instrumental`
    - **集中したい時:** `focus`, `study`, `instrumental`, `classical`, `ambient`
    - **パーティー:** `party`, `dance`, `edm`, `remix`, `pop`
    - **切ない気分:** `sad`, `ballad`, `mellow`, `rainy day`
- **受け入れ基準:**
    - GIVEN: 「おまかせ検索」モードで、「今日の気分」に「リラックス」を選択し
    - WHEN: 「検索」ボタンをクリックすると
    - THEN: 曲名またはアルバム名に"chill", "acoustic", "lo-fi"などのキーワードを含む楽曲が検索結果に表示されること。

#### 4.3. PBI-07.3: 検索結果表示機能
- **仕様:**
    - 検索結果として表示されるのは**楽曲のみ**とする。
    - 表示される楽曲の最大件数は、「表示件数」コンボボックスで選択された値（`20`または`50`）に従う。
    - 検索結果の各楽曲は、「アルバムカバー画像 - 曲タイトル - アーティスト名 - **(所属プレイリスト名)**」の形式で表示し、どのプレイリストの曲かが分かるようにする。
    - 検索結果が0件の場合は、「該当する楽曲が見つかりませんでした。」というメッセージを表示する。
- **受け入れ基準:**
    - GIVEN: 検索を実行し、100件の楽曲がヒットしたとき
    - WHEN: 「表示件数」が`20`に設定されていると
    - THEN: 検索結果リストには20件の楽曲が表示されること。
    - GIVEN: 検索結果のリストに表示された楽曲に
    - THEN: その楽曲が含まれているプレイリストの名前が付記されていること。
    - GIVEN: 検索条件に一致する楽曲が存在しないとき
    - THEN: 検索結果エリアに「該当する楽曲が見つかりませんでした。」と表示されること。

### 5. 非機能仕様

#### 5.1. パフォーマンス
- **データキャッシュ:** アプリケーション起動時または初回検索時に、全プレイリストの全楽曲情報をメモリ上にキャッシュし、検索の都度APIを呼び出すことを避ける。これにより、高速な検索応答を実現する。
- **検索実行タイミング:** ユーザー体験とシステム負荷を考慮し、検索は「検索」ボタンのクリック時に実行する。リアルタイムのインクリメンタルサーチは初期実装では見送る。

#### 5.2. ユーザビリティ
- **状態のクリア:** 「クリア」ボタンにより、全ての検索条件入力と検索結果を一度にリセットし、初期状態に戻せるようにする。
- **検索中のフィードバック:** 検索処理中は「検索中...」といったインジケーターを表示し、ユーザーに処理中であることを明確に伝える。