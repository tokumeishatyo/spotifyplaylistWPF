## Spotifyプレイリスト管理アプリケーション 要件定義書【WPF版 v1.1 スクラム開発導入版】

### 1. 概要

#### 1.1. アプリケーションの目的
本アプリケーションは、ユーザーが自身のSpotifyアカウントに連携し、**Windowsデスクトップ上**で直感的にプレイリストおよびプレイリスト内の楽曲を管理・整理することを目的とする。特に、不要になったプレイリストや楽曲を簡単に選択し、一括で削除する機能を提供することで、ユーザーの音楽ライブラリのメンテナンスを効率化する。

#### 1.2. アプリケーションの概要
Spotifyアカウントでログインすることで、ユーザーが所有またはフォローしているプレイリストの一覧を表示する**WPFデスクトップアプリケーション**。ユーザーは各プレイリストを展開して楽曲を確認し、不要なアイテム（プレイリスト/楽曲）をチェックボックスで選択後、一括で削除することができる。

#### 1.3. ターゲットユーザー
日常的にSpotifyを利用し、多数のプレイリストや楽曲を管理しているWindowsユーザー。

#### 1.4. 前提条件
本アプリケーションは、個人のWindows PC環境でのみ使用することを前提とする。

#### 1.5. 開発プロセス
- **開発手法:** 本プロジェクトは、アジャイル開発手法の一つである**スクラム**を採用して開発を進める。
- **要件管理:** 機能要件は**プロダクトバックログ**として管理する。本書では、初期のプロダクトバックログアイテムを定義する。バックログは市場やユーザーのフィードバックに基づき、継続的に見直され、優先順位が変更される可能性がある。
- **リリース計画:** まず、中核となる価値を提供する**MVP (Minimum Viable Product)** のリリースを目指す。MVPの範囲は、本ドキュメントのプロダクトバックログで定義する。その後、スプリント単位での反復的な機能追加・改善を行う。

### 2. システム要件

#### 2.1. システム構成
- **種別:** Windowsデスクトップアプリケーション
- **フレームワーク:** WPF (.NET)
- **開発言語:** C#, XAML
- **アーキテクチャ:**
    - **MVVM (Model-View-ViewModel) パターンを必須とする。**
        - **View:** XAMLでUIを定義。コードビハインドは最小限に留める。
        - **ViewModel:** UIの状態とロジックを保持。Viewとデータバインディングで接続。
        - **Model:** アプリケーションのデータ構造とビジネスロジックを定義。
    - **DI (Dependency Injection) コンテナの利用を強く推奨する。** (例: `Microsoft.Extensions.DependencyInjection`)
        - ViewModelやServiceクラス間の依存関係を疎結合に保ち、テスト容易性と拡張性を確保する。
- **認証方式:** **Authorization Code Flow with PKCE (Proof Key for Code Exchange)**
    - **補足:** `Client Secret` を使用しない、デスクトップアプリケーション向けの安全な標準認証方式。

#### 2.2. 動作環境
- **対応OS:** Windows 10, Windows 11 (64bit)
- **必須ランタイム:** .NET Runtime (アプリケーションに同梱または別途インストール)

### 3. プロダクトバックログ

#### 3.1. プロダクトバックログアイテム一覧
| PBI ID | 機能名 (ユーザーストーリー) | 概要 | 優先度 | MVP対象 |
| :--- | :--- | :--- | :--- | :--- |
| PBI-01 | **認証:** Spotifyユーザーとして、安全にアプリにログイン/ログアウトしたい | Spotifyアカウントで認証し、アプリの利用を開始/終了する | **Must** | ✅ |
| PBI-02 | **プレイリスト表示:** ログイン後、自分の全プレイリストを一覧で確認したい | 自分が所有/フォローするプレイリストをリスト形式で表示する | **Must** | ✅ |
| PBI-03 | **楽曲表示:** プレイリストを展開し、中に含まれる楽曲を一覧で確認したい | 各プレイリスト内の楽曲を詳細表示する | **Must** | ✅ |
| PBI-04 | **アイテム選択:** 削除したいプレイリストや楽曲を複数選択したい | チェックボックスで削除対象のアイテムをマークする | **Must** | ✅ |
| PBI-05 | **アイテム削除:** 選択したアイテムを一括で削除したい | 選択したプレイリスト/楽曲をSpotifyアカウントから削除する | **Must** | ✅ |
| PBI-06 | **テーマ切替:** 目の疲れを軽減するため、ライト/ダークテーマを切り替えたい | アプリケーションの配色をライトモードとダークモードで変更する | **Should** | ✅ |
| PBI-07 | **検索:** 特定の曲を探すため、全プレイリストを横断して楽曲を検索したい | キーワードで楽曲名やアーティスト名を検索する | **Should** | ❌ |
| PBI-08 | **重複検出:** ライブラリを整理するため、プレイリスト内の重複曲を検出・削除したい | 同一プレイリスト内の重複楽曲を自動で検出し、削除を提案する | **Could** | ❌ |
| PBI-09 | **設定:** アプリの動作をカスタマイズするため、設定画面が欲しい | キャッシュのクリアやAPIスコープの確認などを行える画面 | **Could** | ❌ |

#### 3.2. 主なプロダクトバックログアイテムの詳細

##### 3.2.1. PBI-01: Spotify認証機能
1.  **認証フロー:**
    - **`Client Secret` を使用しない安全な認証方式を採用する。**
    - 本アプリケーションは、Spotify APIを利用するために、Spotifyによって発行される`Client ID`で自身を識別します。これは公開情報であり、アプリケーションに含める必要があります。一方で、**`Client Secret`のような秘密鍵は一切使用しません。**
    - 認証には、デスクトップアプリケーションの標準として推奨される **Authorization Code Flow with PKCE (Proof Key for Code Exchange)** を採用します。これにより、どのSpotifyユーザーも自身の資格情報で安全にログインでき、汎用的な利用が可能になります。
    - ユーザーが「Spotifyでログイン」ボタンをクリックすると、OSの既定ブラウザが起動し、Spotifyの認証ページへ遷移します。
2.  **トークンの永続化:**
    - 認証後に取得する**リフレッシュトークン**は、**Windows Credential Manager (資格情報マネージャー)** を使用してユーザーのPC内に安全に保存します。これにより、アプリ再起動時の自動ログインを実現します。
3.  **ログアウト処理:**
    - ユーザーが「ログアウト」を選択すると、Credential Managerに保存されたトークンを削除し、初期のログイン画面に戻ります。
4.  **必要なAPIスコープ:**
    - `playlist-read-private`, `playlist-read-collaborative`
    - `playlist-modify-public`, `playlist-modify-private`

##### 3.2.2. PBI-02 & PBI-03: プレイリスト・楽曲表示機能
1.  **実装方法:**
    - `TreeView`コントロール、または`ItemsControl`と`Expander`を組み合わせた階層表示を実装する。
    - `MainViewModel`は、プレイリストのコレクション (`ObservableCollection<PlaylistViewModel>`) を保持する。
    - `PlaylistViewModel`は、楽曲のコレクション (`ObservableCollection<TrackViewModel>`) を保持する。
2.  **表示形式:**
    - プレイリスト: 「カバー画像 - タイトル」
    - 楽曲: 「アルバムカバー画像 - 曲タイトル - アーティスト名」
3.  **データ取得:**
    - 全てのAPIアクセスは**非同期 (`async/await`)** で実行し、UIの応答性を維持する。
    - プレイリスト展開時に、そのプレイリストの楽曲を初めて取得する（遅延読み込み）。

##### 3.2.3. PBI-04 & PBI-05: アイテム選択・削除機能
1.  **選択機能:**
    - 各アイテムの`CheckBox`とViewModelの`IsSelected`プロパティを双方向バインディングする。
    - 1つでもアイテムが選択されると、「Delete」ボタンが活性化される。
2.  **削除機能:**
    - `ICommand`パターンを用いて削除ロジックを実装する。
    - 削除実行前に、OS標準のメッセージボックスで最終確認を行う。
    - 削除処理中はUI上にプログレスインジケーターを表示し、処理がバックグラウンドで実行されていることをユーザーに示す。
    - 処理完了後、プレイリスト一覧をリフレッシュして結果を反映する。

### 4. 非機能要件

#### 4.1. ユーザビリティ・UI/UX
- **レスポンシブUI:** ウィンドウサイズに応じてコントロールが適切にリサイズされるレイアウトを組む。
- **テーマ対応:** `ResourceDictionary`を活用し、ライトテーマとダークテーマを切り替えられる機構を設ける。
- **フィードバック:** API通信中や削除処理中など、時間がかかる処理ではUI上にプログレスリングや「処理中...」といったインジケーターを表示し、UIがフリーズしていないことをユーザーに示す。

#### 4.2. パフォーマンス
- **非同期処理の徹底:** 全てのAPI通信や時間のかかる処理は`async/await`を用いて非同期で実行し、UIスレッドのブロッキングを完全に回避する。
- **UI仮想化:** プレイリストや楽曲リストを表示する`ItemsControl`では、`VirtualizingStackPanel`を有効にし、大量のアイテムを効率的に描画する。

#### 4.3. セキュリティ
- **認証情報の管理:**
    - Spotify APIの `Client ID` はアプリケーション構成ファイル (`appsettings.json`など) に記述する。`Client Secret` はPKCEフローでは不要。
    - 構成ファイルはGitなどのバージョン管理システムの追跡対象から除外する。
- **トークンの保管:**
    - ユーザーのリフレッシュトークンは、**Windows Credential Manager**に暗号化して保存する。平文でファイルに保存しない。

#### 4.4. 拡張性・保守性
- **MVVMの遵守:** View、ViewModel、Modelの責務を厳密に分離する。ViewはUI定義に専念し、ロジックはViewModelに実装する。
- **DIの活用:** Service（例: `SpotifyApiService`, `CredentialService`）をインターフェースとして定義し、DIコンテナ経由でViewModelに注入する。これにより、各コンポーネントが独立して開発・テスト可能になる。
- **モジュール化:** 将来の機能（検索、設定など）は、それぞれ独立したView/ViewModelとして実装し、メインのUIに動的に組み込めるように設計する。

### 5. 外部インターフェース

#### 5.1. Spotify Web API
- **推奨ライブラリ:** **`SpotifyAPI-NET`** のような実績のあるNuGetパッケージの利用を強く推奨する。これにより、APIコールの実装、認証フロー、モデルのマッピングが大幅に簡略化される。
- **API規約:** Spotify Web APIの利用規約およびデザインガイドラインを遵守する。
- **レートリミット:** APIのレートリミット（429エラー）をハンドリングし、エラーが発生した場合はユーザーに通知してリトライを促す。

### 6. その他

#### 6.1. 開発・配布
- **配布形式:** **MSIX**パッケージ形式での配布を推奨する。これにより、ストア経由またはサイドロードでの容易なインストール、自動更新、クリーンなアンインストールが可能になる。
- **推奨ライブラリ (NuGet):**
    - `SpotifyAPI-NET`: Spotify APIクライアント
    - `Microsoft.Extensions.DependencyInjection`: DIコンテナ
    - `CommunityToolkit.Mvvm`: MVVMパターンの実装を補助 (ObservableObject, RelayCommandなど)